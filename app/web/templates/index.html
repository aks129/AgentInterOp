<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Connectathon Demo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container-fluid">
            <h1>Multi-Agent Connectathon Demo</h1>
            <div class="protocol-toggle">
                <label>
                    <input type="radio" name="protocol" value="A2A" checked>
                    A2A
                </label>
                <label>
                    <input type="radio" name="protocol" value="MCP">
                    MCP
                </label>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Left Pane: Transcript -->
        <div class="left-pane">
            <h2>Transcript</h2>
            <div id="transcript" class="transcript"></div>
            
            <!-- Experimental Agent UX -->
            <div id="experimental-agent-ux-panel" class="experimental-panel mt-4" style="display: none;">
                <h3>Agent UX</h3>
                
                <!-- BCS Test Harness -->
                <div class="bcs-test-section mb-4">
                    <h4>BCS Test Harness</h4>
                    <button id="run-bcs-tests-btn" class="btn btn-outline-primary btn-sm">Run BCS Tests</button>
                    <div id="bcs-test-results" class="mt-3" style="display: none;">
                        <div id="bcs-test-list" class="test-results"></div>
                    </div>
                </div>
                
                <!-- Two-Lane Transcript -->
                <div class="two-lane-transcript">
                    <h4>Agent Conversation</h4>
                    <div class="transcript-lanes">
                        <div class="applicant-lane">
                            <h5>Applicant</h5>
                            <div id="applicant-messages" class="agent-messages"></div>
                        </div>
                        <div class="administrator-lane">
                            <h5>Administrator</h5>
                            <div id="administrator-messages" class="agent-messages"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Claude Response Generator -->
                <div class="claude-response-section mt-4">
                    <h4>Generate Response</h4>
                    <div class="mb-3">
                        <label for="response-role" class="form-label">Role:</label>
                        <select id="response-role" class="form-select form-select-sm">
                            <option value="applicant">Applicant</option>
                            <option value="administrator">Administrator</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="response-hint" class="form-label">Hint:</label>
                        <select id="response-hint" class="form-select form-select-sm">
                            <option value="requirements">Requirements</option>
                            <option value="docs">Documentation</option>
                            <option value="decision">Decision</option>
                            <option value="slots">Scheduling</option>
                            <option value="free">Free Response</option>
                        </select>
                    </div>
                    <button id="generate-response-btn" class="btn btn-primary btn-sm">Generate Response</button>
                    
                    <!-- Generated Response Card -->
                    <div id="generated-response-card" class="mt-3" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Generated Response</span>
                                <button id="use-response-btn" class="btn btn-success btn-sm">Use This Response</button>
                            </div>
                            <div class="card-body">
                                <div id="response-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Autonomous BCS v2 Panel -->
                <div id="autonomous-v2-panel" class="experimental-panel mt-4" style="display: none;">
                    <h3>Autonomous BCS (v2)</h3>
                    
                    <!-- Endpoints & Servers -->
                    <div class="mb-4">
                        <h5>Endpoints & Servers</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="applicant-endpoint" class="form-label">Applicant A2A Endpoint:</label>
                                <input type="url" id="applicant-endpoint" class="form-control form-control-sm" 
                                       placeholder="https://applicant.example.com/a2a">
                                <button id="test-applicant-btn" class="btn btn-outline-secondary btn-sm mt-1">Test</button>
                            </div>
                            <div class="col-md-6">
                                <label for="administrator-endpoint" class="form-label">Administrator A2A Endpoint:</label>
                                <input type="url" id="administrator-endpoint" class="form-control form-control-sm" 
                                       placeholder="https://admin.example.com/a2a">
                                <button id="test-administrator-btn" class="btn btn-outline-secondary btn-sm mt-1">Test</button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-8">
                                <label for="fhir-base-url" class="form-label">MCP-FHIR Base URL:</label>
                                <input type="url" id="fhir-base-url" class="form-control form-control-sm" 
                                       value="https://hapi.fhir.org/baseR4" placeholder="https://hapi.fhir.org/baseR4">
                            </div>
                            <div class="col-md-4">
                                <label for="fhir-token" class="form-label">Token:</label>
                                <input type="password" id="fhir-token" class="form-control form-control-sm" 
                                       placeholder="Bearer token (optional)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient & Data -->
                    <div class="mb-4">
                        <h5>Patient & Data</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="patient-id" class="form-label">Patient ID:</label>
                                <input type="text" id="patient-id" class="form-control form-control-sm" 
                                       placeholder="Patient resource ID">
                            </div>
                            <div class="col-md-4">
                                <button id="fetch-everything-btn" class="btn btn-primary btn-sm mt-4">Fetch $everything</button>
                            </div>
                        </div>
                        
                        <!-- Minimal Facts Preview -->
                        <div id="minimal-facts-preview" class="mt-3" style="display: none;">
                            <h6>Extracted Facts:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="fact-sex" class="form-label">Sex:</label>
                                    <input type="text" id="fact-sex" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-4">
                                    <label for="fact-birth-date" class="form-label">Birth Date:</label>
                                    <input type="date" id="fact-birth-date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-4">
                                    <label for="fact-last-mammogram" class="form-label">Last Mammogram:</label>
                                    <input type="date" id="fact-last-mammogram" class="form-control form-control-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guidelines -->
                    <div class="mb-4">
                        <h5>Guidelines</h5>
                        <div class="mb-2">
                            <button id="load-guidelines-btn" class="btn btn-outline-primary btn-sm me-2">Load Current</button>
                            <button id="restore-guidelines-btn" class="btn btn-outline-secondary btn-sm">Restore Defaults</button>
                        </div>
                        <textarea id="guidelines-editor" class="form-control font-monospace" rows="8" 
                                  placeholder="BCS guidelines JSON..."></textarea>
                    </div>
                    
                    <!-- Run Options -->
                    <div class="mb-4">
                        <h5>Run Options</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="max-turns" class="form-label">Max Turns:</label>
                                <input type="number" id="max-turns" class="form-control form-control-sm" value="8" min="2" max="20">
                            </div>
                            <div class="col-md-3">
                                <label for="sse-timeout" class="form-label">SSE Timeout (ms):</label>
                                <input type="number" id="sse-timeout" class="form-control form-control-sm" value="8000" min="1000" max="30000">
                            </div>
                            <div class="col-md-3">
                                <label for="poll-interval" class="form-label">Poll Interval (ms):</label>
                                <input type="number" id="poll-interval" class="form-control form-control-sm" value="1200" min="500" max="5000">
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="dry-run" checked>
                                    <label class="form-check-label" for="dry-run">Dry Run</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Run Controls -->
                    <div class="mb-4">
                        <h5>Run Controls</h5>
                        <button id="start-autonomous-btn" class="btn btn-success me-2">Start Autonomous Run</button>
                        <button id="cancel-autonomous-btn" class="btn btn-danger" disabled>Cancel</button>
                        <span id="autonomous-status" class="ms-3 small text-muted"></span>
                    </div>
                    
                    <!-- Quick Tests -->
                    <div class="mb-4">
                        <h5>Quick Tests</h5>
                        <div class="btn-group" role="group">
                            <button id="test-eligible-btn" class="btn btn-outline-success btn-sm">Eligible Test</button>
                            <button id="test-needs-info-btn" class="btn btn-outline-warning btn-sm">Needs Info Test</button>
                            <button id="test-ineligible-btn" class="btn btn-outline-danger btn-sm">Ineligible Test</button>
                        </div>
                        <div id="quick-test-results" class="mt-2" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Pane: Artifacts -->
        <div class="center-pane">
            <h2>Artifacts</h2>
            <div id="artifacts" class="artifacts">
                <p class="no-artifacts">No artifacts available</p>
            </div>
            
            <!-- Autonomous Dialog Live View -->
            <div id="autonomous-live-view" style="display: none;">
                <h2>Autonomous Dialog</h2>
                
                <!-- Arbiter Decision Bar -->
                <div id="arbiter-decision-bar" class="alert alert-info" style="display: none;">
                    <strong>Chosen Outcome:</strong> <span id="arbiter-decision"></span> - 
                    <span id="arbiter-rationale"></span>
                </div>
                
                <!-- Two-Lane Autonomous Transcript -->
                <div class="autonomous-transcript-lanes">
                    <div class="autonomous-applicant-lane">
                        <h5>Applicant Agent</h5>
                        <div id="autonomous-applicant-messages" class="autonomous-agent-messages"></div>
                    </div>
                    <div class="autonomous-administrator-lane">
                        <h5>Administrator Agent</h5>
                        <div id="autonomous-administrator-messages" class="autonomous-agent-messages"></div>
                    </div>
                </div>
                
                <!-- Export Controls -->
                <div class="mt-3">
                    <button id="export-transcript-btn" class="btn btn-outline-primary btn-sm">Export Transcript</button>
                    <span id="dialog-progress" class="ms-3 small text-muted"></span>
                </div>
            </div>

            <!-- Schedule Screening Panel -->
            <div id="schedule-screening-panel" class="schedule-screening mt-4" style="display: none;">
                <h3>Schedule Screening</h3>
                
                <!-- Search Form -->
                <div class="scheduling-search-form">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="search-specialty" class="form-label">Specialty:</label>
                            <input type="text" id="search-specialty" class="form-control form-control-sm" 
                                value="mammography" placeholder="e.g., mammography">
                        </div>
                        <div class="col-md-6">
                            <label for="search-radius" class="form-label">Radius (km):</label>
                            <input type="number" id="search-radius" class="form-control form-control-sm" 
                                value="50" min="1" max="500">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label for="search-start-date" class="form-label">Start Date:</label>
                            <input type="date" id="search-start-date" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label for="search-end-date" class="form-label">End Date:</label>
                            <input type="date" id="search-end-date" class="form-control form-control-sm">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label for="search-org" class="form-label">Organization (contains):</label>
                            <input type="text" id="search-org" class="form-control form-control-sm" 
                                placeholder="Optional filter">
                        </div>
                        <div class="col-md-6">
                            <label for="search-location" class="form-label">Location:</label>
                            <input type="text" id="search-location" class="form-control form-control-sm" 
                                placeholder="City, State">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button id="search-slots-btn" class="btn btn-primary btn-sm">Search Slots</button>
                        <button id="try-scheduling-btn" class="btn btn-outline-secondary btn-sm ms-2">Try Scheduling</button>
                    </div>
                </div>

                <!-- Search Status -->
                <div id="slot-search-status" class="mt-3" style="display: none;">
                    <div class="alert alert-info" role="status" aria-live="polite">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                            Searching for available slots...
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="slot-search-results" class="mt-3" style="display: none;">
                    <h4>Available Slots</h4>
                    <div id="slot-results-list" class="slot-results"></div>
                </div>

                <!-- Empty Results -->
                <div id="slot-empty-results" class="mt-3" style="display: none;">
                    <div class="alert alert-warning">
                        <p><strong>No slots found.</strong></p>
                        <p>Try a larger time window or radius, or clear the specialty filter.</p>
                    </div>
                </div>

                <!-- Error Results -->
                <div id="slot-error-results" class="mt-3" style="display: none;">
                    <div class="alert alert-danger">
                        <p><strong>Search failed.</strong></p>
                        <p id="slot-error-message">An error occurred while searching for slots.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Pane: Connectathon Settings -->
        <div class="right-pane">
            <!-- Experimental Right Rail Tabs -->
            <div id="experimental-right-rail" class="experimental-tabs" style="display: none;">
                <ul class="nav nav-tabs" id="right-rail-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="trace-tab" data-bs-toggle="tab" data-bs-target="#trace-panel" type="button" role="tab">Trace</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="artifacts-tab" data-bs-toggle="tab" data-bs-target="#artifacts-panel" type="button" role="tab">Artifacts</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw-panel" type="button" role="tab">Raw</button>
                    </li>
                </ul>
                <div class="tab-content" id="right-rail-content">
                    <div class="tab-pane fade show active" id="trace-panel" role="tabpanel">
                        <div class="p-3">
                            <h6>Conversation Trace</h6>
                            <div id="conversation-trace" class="trace-content"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="artifacts-panel" role="tabpanel">
                        <div class="p-3">
                            <h6>Generated Artifacts</h6>
                            <div id="generated-artifacts" class="artifacts-content"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="raw-panel" role="tabpanel">
                        <div class="p-3">
                            <h6>Raw JSON</h6>
                            <pre id="raw-json" class="raw-content"><code>No data available</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel">
                <h2>Connectathon Settings</h2>
                
                <!-- Self-test Badge -->
                <div class="selftest-badge mb-3">
                    <span id="selftest-status" class="badge bg-secondary">Checking...</span>
                </div>

                <!-- Scenario Selection -->
                <div class="mb-3">
                    <label for="scenario-select" class="form-label">Scenario:</label>
                    <select id="scenario-select" class="form-select form-select-sm">
                        <option value="bcse">BCS-E</option>
                        <option value="clinical_trial">Clinical Trial</option>
                        <option value="referral_specialist">Referral Specialist</option>
                        <option value="prior_auth">Prior Authorization</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <!-- Mode Selection -->
                <div class="mb-3">
                    <label class="form-label">Mode:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="mode-applicant" value="applicant_only">
                        <label class="form-check-label" for="mode-applicant">Applicant-only</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="mode-admin" value="administrator_only">
                        <label class="form-check-label" for="mode-admin">Administrator-only</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="mode-full" value="full_stack" checked>
                        <label class="form-check-label" for="mode-full">Full-stack</label>
                    </div>
                </div>

                <!-- Simulation Controls -->
                <div class="mb-3">
                    <label class="form-label">Simulation:</label>
                    <div class="mb-2">
                        <label for="admin-processing-ms" class="form-label">Admin Processing (ms):</label>
                        <input type="number" id="admin-processing-ms" class="form-control form-control-sm" value="1200" min="0">
                    </div>
                    <div class="mb-2">
                        <label for="error-injection-rate" class="form-label">Error Injection Rate (0-1):</label>
                        <input type="number" id="error-injection-rate" class="form-control form-control-sm" value="0.0" min="0" max="1" step="0.1">
                    </div>
                    <div class="mb-2">
                        <label for="capacity-limit" class="form-label">Capacity Limit:</label>
                        <input type="number" id="capacity-limit" class="form-control form-control-sm" placeholder="Leave blank for unlimited" min="1">
                    </div>
                </div>

                <!-- Protocol Default -->
                <div class="mb-3">
                    <label class="form-label">Protocol Default:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="protocol-default" id="protocol-a2a" value="a2a" checked>
                        <label class="form-check-label" for="protocol-a2a">A2A</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="protocol-default" id="protocol-mcp" value="mcp">
                        <label class="form-check-label" for="protocol-mcp">MCP</label>
                    </div>
                </div>

                <!-- Experimental Features -->
                <div class="mb-3 experimental-section">
                    <label class="form-label">Experimental Features:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="experimental-agent-ux" value="1">
                        <label class="form-check-label" for="experimental-agent-ux">
                            Enable Agent UX
                            <small class="text-muted d-block">Claude-powered agent responses & BCS testing</small>
                        </label>
                    </div>
                    <div id="claude-status" class="mt-2 small text-muted" style="display: none;">
                        <span id="claude-status-indicator" class="badge bg-secondary">Checking...</span>
                        <span id="claude-status-text">Claude API status</span>
                    </div>
                    
                    <!-- Claude API Key Input -->
                    <div id="claude-api-key-section" class="mt-3" style="display: none;">
                        <label for="claude-api-key" class="form-label">Claude API Key:</label>
                        <div class="input-group">
                            <input type="password" id="claude-api-key" class="form-control form-control-sm" 
                                   placeholder="sk-ant-api03-...">
                            <button id="save-api-key-btn" class="btn btn-outline-primary btn-sm">Save</button>
                        </div>
                        <small class="text-muted">For session use only. Get your key from <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></small>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="mb-3">
                    <button id="save-settings-btn" class="btn btn-primary btn-sm w-100 mb-2">Save Settings</button>
                    <button id="reset-config-btn" class="btn btn-outline-secondary btn-sm w-100 mb-2">Reset Config</button>
                    <button id="examples-btn" class="btn btn-info btn-sm w-100">Examples</button>
                </div>

                <!-- Requirements Display -->
                <div class="requirements-section">
                    <h6>Current Requirements:</h6>
                    <div id="requirements-text" class="small text-muted">Loading...</div>
                </div>

                <!-- Applicant Payload Override -->
                <div class="mt-3">
                    <label for="applicant-payload" class="form-label">Applicant Payload (optional JSON):</label>
                    <textarea id="applicant-payload" class="form-control form-control-sm" rows="4" style="font-family: monospace;" placeholder='{"age": 56, "sex": "female"}'></textarea>
                    <div id="payload-error" class="text-danger small mt-1" style="display: none;"></div>
                </div>

                <!-- Export Tools -->
                <div class="mt-3">
                    <h6>Export Tools:</h6>
                    <button id="export-transcript-btn" class="btn btn-outline-info btn-sm w-100">Export Transcript & Artifacts</button>
                </div>
            </div>

            <!-- Scheduling Links Configuration -->
            <div class="scheduling-links-panel mt-4">
                <h3>Scheduling Links</h3>
                
                <!-- Publishers Configuration -->
                <div class="mb-3">
                    <label for="scheduling-publishers" class="form-label">Publishers (one URL per line):</label>
                    <textarea id="scheduling-publishers" class="form-control form-control-sm" rows="3" 
                        placeholder="https://zocdoc-smartscheduling.netlify.app"
                        style="font-family: monospace;"></textarea>
                    <div class="form-text">Each URL must support /$bulk-publish endpoint</div>
                </div>

                <!-- Cache TTL -->
                <div class="mb-3">
                    <label for="scheduling-cache-ttl" class="form-label">Cache TTL (seconds):</label>
                    <input type="number" id="scheduling-cache-ttl" class="form-control form-control-sm" 
                        value="300" min="60" max="3600">
                </div>

                <!-- Default Specialty -->
                <div class="mb-3">
                    <label for="scheduling-specialty" class="form-label">Default Specialty:</label>
                    <input type="text" id="scheduling-specialty" class="form-control form-control-sm" 
                        value="mammography" placeholder="e.g., mammography">
                </div>

                <!-- Default Radius -->
                <div class="mb-3">
                    <label for="scheduling-radius" class="form-label">Default Radius (km):</label>
                    <input type="number" id="scheduling-radius" class="form-control form-control-sm" 
                        value="50" min="1" max="500">
                </div>

                <!-- Default Timezone -->
                <div class="mb-3">
                    <label for="scheduling-timezone" class="form-label">Default Timezone:</label>
                    <input type="text" id="scheduling-timezone" class="form-control form-control-sm" 
                        value="America/New_York" placeholder="e.g., America/New_York">
                </div>

                <!-- Action Buttons -->
                <div class="mb-3">
                    <button id="save-scheduling-btn" class="btn btn-primary btn-sm w-100 mb-2">Save Scheduling Config</button>
                    <button id="test-publishers-btn" class="btn btn-success btn-sm w-100 mb-2">Test Publishers</button>
                </div>

                <!-- Test Results -->
                <div id="publisher-test-results" class="mt-2" style="display: none;">
                    <h6>Test Results:</h6>
                    <div id="publisher-results-content" class="small"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Patient selection -->
    <div class="patient-selection mb-3">
        <label for="patient-select" class="form-label">Patient Case:</label>
        <select id="patient-select" class="form-select form-select-sm">
            <option value="001">001.json (Eligible - Recent mammogram)</option>
            <option value="001_missing_mammo">001_missing_mammo.json (Ineligible - Old mammogram)</option>
        </select>
    </div>

    <!-- Control Buttons -->
    <div class="controls">
        <button id="start-demo-btn" class="btn btn-primary">Start Demo</button>
        <button id="send-applicant-info-btn" class="btn btn-secondary" disabled>Send Applicant Info</button>
        <button id="reset-btn" class="btn btn-outline">Reset</button>
    </div>

    <!-- Custom JavaScript -->
    <script src="/static/app.js"></script>
    
    <!-- Experimental UI Controller -->
    <script src="/static/app.experimental.js"></script>
    <script src="/static/app.autonomous_v2.js"></script>
</body>
</html>
