; Asterisk Dialplan for AgentInterOp Telephony
; Routes calls between AWS Chime and Voice Agent Server

[general]
static=yes
writeprotect=no
clearglobalvars=no

; =============================================================================
; Global Variables
; =============================================================================

[globals]
STASIS_APP=voice-agent
; Name of the Stasis app that handles calls

; =============================================================================
; Inbound Calls from AWS Chime
; =============================================================================

[from-chime]
; All inbound calls from AWS Chime come here

; Answer and route to voice agent
exten => _X.,1,NoOp(Inbound call from ${CALLERID(num)} to ${EXTEN})
 same => n,Answer()
 same => n,Wait(0.5)
 ; Hand off to Stasis application (our shim server picks up from here)
 same => n,Stasis(${STASIS_APP},inbound,${CALLERID(num)},${EXTEN})
 same => n,Hangup()

; Fallback for any unmatched patterns
exten => _.,1,NoOp(Unknown call pattern: ${EXTEN})
 same => n,Hangup()

; =============================================================================
; Outbound Calls (Agent calling external numbers)
; =============================================================================

[outbound]
; Outbound calls initiated by the voice agent

; US/Canada numbers (E.164 format: +1XXXXXXXXXX)
exten => _+1NXXNXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLER_ID})
 same => n,Dial(PJSIP/${EXTEN}@aws-chime,60,b(handler^addheader^1))
 same => n,Hangup()

; Generic E.164 (for international if needed)
exten => _+X.,1,NoOp(International call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLER_ID})
 same => n,Dial(PJSIP/${EXTEN}@aws-chime,60)
 same => n,Hangup()

; Handler for adding custom headers
[handler]
exten => addheader,1,Set(PJSIP_HEADER(add,X-Agent-Call)=true)
 same => n,Return()

; =============================================================================
; External Media Context
; =============================================================================

[external-media]
; Context for ExternalMedia channels (used by shim server)
; Calls here are bridged to the external RTP stream

exten => s,1,NoOp(External media channel)
 same => n,Answer()
 same => n,Wait(86400)
 ; Keep alive until terminated by ARI
 same => n,Hangup()

; =============================================================================
; Internal Testing
; =============================================================================

[internal]
; For local testing without AWS Chime

; Echo test
exten => 1000,1,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Connect to voice agent
exten => 1001,1,Answer()
 same => n,Wait(0.5)
 same => n,Stasis(${STASIS_APP},internal,test,1001)
 same => n,Hangup()

; Playback test (TTS check)
exten => 1002,1,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()
